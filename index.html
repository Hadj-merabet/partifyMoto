<script>
  // Construis des selects plus riches ici (tu peux adapter le HTML existant)
  const searchBlock = document.querySelector('#search') || document.body;
  // create simple form if absent
  if (!document.querySelector('#part-search-form')) {
    const html = `
      <div id="part-search-form" class="p-4 bg-white rounded shadow">
        <label>Marque
          <select id="brand">
            <option value="">-- Choisir --</option>
            <option>Yamaha</option>
            <option>Honda</option>
            <option>Kawasaki</option>
            <option>KTM</option>
            <option>Husqvarna</option>
            <option>Suzuki</option>
            <option>Beta</option>
            <option>GasGas</option>
            <option>TM</option>
            <option>Other</option>
          </select>
        </label>
        <label>Modèle
          <select id="model">
            <option value="">-- Choisir --</option>
            <!-- road / sport / adventure -->
            <option>MT-07</option>
            <option>MT-09</option>
            <option>Tracer 7</option>
            <option>Tracer 9</option>
            <option>Ténéré 700</option>
            <option>Tenere 700</option>
            <option>YZ 250</option>
            <option>CRF450R</option>
            <option>SX 350</option>
            <option>Z900</option>
            <option>CB650</option>
            <option>Other</option>
          </select>
        </label>
        <label>Année
          <select id="year">
            <option value="">-- Choisir --</option>
            ${Array.from({length: 15}).map((_,i) => {
              const y = 2025 - i;
              return `<option>${y}</option>`;
            }).join('')}
          </select>
        </label>
        <label>Type de pièce
          <select id="originPref">
            <option value="ANY">Tous</option>
            <option value="OEM">Origine (OEM)</option>
            <option value="AFTERMARKET">Non-origine (Aftermarket)</option>
          </select>
        </label>
        <button id="searchBtn">Rechercher</button>
      </div>
    `;
    const container = document.createElement('div');
    container.innerHTML = html;
    searchBlock.prepend(container);
  }

  const brandEl = document.getElementById('brand');
  const modelEl = document.getElementById('model');
  const yearEl = document.getElementById('year');
  const originEl = document.getElementById('originPref');
  const btn = document.getElementById('searchBtn');

  // results container
  let resultsContainer = document.getElementById('search-results');
  if (!resultsContainer) {
    resultsContainer = document.createElement('div');
    resultsContainer.id = 'search-results';
    document.querySelector('#part-search-form').after(resultsContainer);
  }

  async function doSearch() {
    const brand = brandEl.value;
    const model = modelEl.value;
    const year = yearEl.value;
    const originPreference = originEl.value;

    if (!brand || !model || !year) {
      resultsContainer.innerHTML = '<div style="color:#b91c1c">Sélectionne marque, modèle et année.</div>';
      return;
    }

    resultsContainer.innerHTML = '<div>Recherche…</div>';
    try {
      const resp = await fetch('http://localhost:3000/api/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ brand, model, year, originPreference })
      });
      if (!resp.ok) throw new Error('Erreur serveur');
      const payload = await resp.json();

      if (!payload.results || payload.results.length === 0) {
        resultsContainer.innerHTML = '<div>Aucune pièce trouvée.</div>';
        return;
      }

      // render each result: show OEM best and Aftermarket best separately
      resultsContainer.innerHTML = '';
      payload.results.forEach(r => {
        const el = document.createElement('div');
        el.style.border = '1px solid #e5e7eb';
        el.style.padding = '12px';
        el.style.marginBottom = '10px';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between">
            <div>
              <div style="font-weight:600">${r.name}</div>
              <div style="font-size:12px;color:#6b7280">${r.partId}</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:12px;color:#6b7280">Choix</div>
              <div style="font-weight:700">${r.chosenBest ? r.chosenBest.price.toFixed(2) + '€' : '—'}</div>
              ${r.chosenBest ? `<a href="${r.chosenBest.url}" target="_blank" style="font-size:12px">Voir</a>` : ''}
            </div>
          </div>
          <div style="margin-top:8px;font-size:13px">
            <div><strong>Meilleure OEM:</strong> ${r.bestOEM ? `${r.bestOEM.price.toFixed(2)}€ — <a href="${r.bestOEM.url}" target="_blank">Voir</a>` : 'Aucune'}</div>
            <div><strong>Meilleure Aftermarket:</strong> ${r.bestAftermarket ? `${r.bestAftermarket.price.toFixed(2)}€ — <a href="${r.bestAftermarket.url}" target="_blank">Voir</a>` : 'Aucune'}</div>
          </div>
          <details style="margin-top:8px">
            <summary>Voir toutes les offres (${r.offers.length})</summary>
            <ul style="margin-top:6px">
              ${r.offers.map(o => `<li>${o.origin} — <a href="${o.url}" target="_blank">${o.seller}</a> — ${o.price.toFixed(2)}€</li>`).join('')}
            </ul>
          </details>
        `;
        resultsContainer.appendChild(el);
      });

    } catch (err) {
      console.error(err);
      resultsContainer.innerHTML = '<div style="color:#b91c1c">Erreur — vérifie que le backend tourne.</div>';
    }
  }

  btn.addEventListener('click', doSearch);
</script>
